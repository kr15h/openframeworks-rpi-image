# It assums S3 credentials to be set up in the repository settings
# or to be configured as encrypted env vars here.

sudo: required
os: linux
dist: trusty
addons:
  apt:
    packages:
    - qemu
    - qemu-user-static
    - binfmt-support
    - parted
    - wget
    - dosfstools
    - zip
    - python

env:
  global:
  - PATH=$HOME/.local/bin:$PATH
  - GPU_MEM_256=128
  - GPU_MEM_512=256
  - GPU_MEM_1024=512
  - AWS_BUCKET="openframeworks-rpi-image"
  - AWS_SHARED="~/shared"

before_install:
- pip install --user awscli
- mkdir -p "${AWS_SHARED}"

jobs:
  include:
  - stage: prepare
    env: RPI_VERSION="raspbian_lite-2017-07-05" RPI_ZIP="2017-07-05-raspbian-jessie-lite.zip" RPI_URL="http://downloads.raspberrypi.org/raspbian_lite/images/${RPI_VERSION}/${RPI_ZIP}" OF_VERSION="v0.10.0" OF_FILE="of_v0.10.0_linuxarmv6l_release.tar.gz" OF_URL="http://openframeworks.cc/versions/${OF_VERSION}/${OF_FILE}" IMAGE="${RPI_VERSION}-of_${OF_VERSION}.img"
    script:
    - sudo bash ./image-prepare.sh
    - zip "${AWS_SHARED}/${IMAGE}.zip" "./${IMAGE}"
    - aws s3 rm "s3://${AWS_BUCKET}/*"
    - aws s3 sync "${AWS_SHARED}" "s3://${AWS_BUCKET}"
  - stage: compile
    env: RPI_VERSION="raspbian_lite-2017-07-05" RPI_ZIP="2017-07-05-raspbian-jessie-lite.zip" RPI_URL="http://downloads.raspberrypi.org/raspbian_lite/images/${RPI_VERSION}/${RPI_ZIP}" OF_VERSION="v0.10.0" OF_FILE="of_v0.10.0_linuxarmv6l_release.tar.gz" OF_URL="http://openframeworks.cc/versions/${OF_VERSION}/${OF_FILE}" IMAGE="${RPI_VERSION}-of_${OF_VERSION}.img"
    script:
    - aws s3 sync "s3://${AWS_BUCKET}" "${AWS_SHARED}"
    - aws s3 rm "s3://${AWS_BUCKET}/*"
    - mv "${AWS_SHARED}/${IMAGE}.zip" "./${IMAGE}.zip"
    - sudo bash ./image-compile.sh
    - zip "${IMAGE}.zip" "./${IMAGE}"
